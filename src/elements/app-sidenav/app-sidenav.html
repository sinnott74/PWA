<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="app-sidenav">
  <!-- Defines the element's style and local DOM -->
  <<!-- link rel="stylesheet" type="text/css" href="app-sidenav.css"> -->
  <template>
    <section class="side-nav js-side-nav">
      <div class="side-nav__content js-side-nav-content">
        <div class="side-nav__header">
          <button class="side-nav__pin" on-click="togglePin"></button>
          <h1 class="side-nav__title">App shell</h1>
        </div>

        <div class="side-nav__body">
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
        </div>

        <div class="side-nav__version">Version @VERSION@</div>
      </div>
    </section>
    <div class="side-nav__edgearea js-side-nav-edgearea"></div>
  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'app-sidenav',

      ready: function(){
        var sideNav = this;
        this.rootElement = document.querySelector('.js-side-nav');
        this.sideNavContent = this.rootElement
          .querySelector('.js-side-nav-content');
        this.sideNavBody = this.rootElement.querySelector('.side-nav__body');
        this.pin = this.rootElement.querySelector('.side-nav__pin');
        this.edge = document.querySelector('.js-side-nav-edgearea');

        this.sideNavContentWidth = this.sideNavContent.offsetWidth;

        this.rootElement.addEventListener('click', function(e) {
          console.log('sidenav root element clicked - closing sidenav');
          sideNav.close();
        });

        this.sideNavContent.addEventListener('click', function(e) {
          console.log('sidenav content clicked - stopping event propagation');
          e.stopPropagation();
        });

        this.hasUnprefixedTransform = 'transform' in document.documentElement.style;
        if (this.hasUnprefixedTransform) {
          // Touch slop is a variable that is defined to suggest anything larger
          // than this value was an intended gesture by the user.
          // 8  is a value from Android platform.
          // 3 was added as a factor made up from what felt right.
          var TOUCH_SLOP = 8 * window.devicePixelRatio * 3;

          var touchStartX;
          var sideNavTransform;

          var onSideNavTouchStart = function(e) {
            sideNavTransform = 0;
            touchStartX = e.touches[0].pageX;
          };

          var onSideNavTouchMove = function(e) {
            var newTouchX = e.touches[0].pageX;
            sideNavTransform = Math.min(0, newTouchX - touchStartX);
            sideNav.sideNavContent.style.transform =
              'translateX(' + sideNavTransform + 'px)';
          };

          var onSideNavTouchEnd = function(e) {
            if (sideNavTransform < -TOUCH_SLOP) {
              sideNav.close();
              return;
            } else if (sideNavTransform < -window.devicePixelRatio/100){
              sideNav.open();
            }
          };

          // Close nav touch
          this.sideNavContent.addEventListener('touchstart', onSideNavTouchStart);
          this.sideNavContent.addEventListener('touchmove', onSideNavTouchMove);
          this.sideNavContent.addEventListener('touchend', onSideNavTouchEnd);

          var edgeTransform;
          var edgeTouchStartX;
          var sideNavContent = this.sideNavContent;
          var sideNavContentWidth;

          var onEdgeTouchStart = function(e) {
            sideNavContentWidth = sideNavContent.offsetWidth;
            edgeTransform = 0;
            edgeTouchStartX = e.touches[0].pageX; 
            sideNav.sideNavContent.style.transform = 'translateX(-95%)';
          };

          var onEdgeTouchMove = function(e) {
            var newEdgeTouchX = e.touches[0].pageX;
            edgeTransform = Math.min(sideNavContentWidth, newEdgeTouchX - edgeTouchStartX);
            sideNav.sideNavContent.style.transform =
               'translateX(' + (-sideNavContentWidth + edgeTransform) + 'px)';
          };

          var onEdgeTouchEnd = function(e) {
            if (edgeTransform >= TOUCH_SLOP) {
              sideNav.open();
              return;
            } else if (edgeTransform < TOUCH_SLOP){
              sideNav.close();
            }
          };

          // Edge touch
          this.edge.addEventListener('touchstart', onEdgeTouchStart);
          this.edge.addEventListener('touchmove', onEdgeTouchMove);
          this.edge.addEventListener('touchend', onEdgeTouchEnd);
        }

        this.isOpen = this.isOpen.bind(this);
        this.toggle = this.toggle.bind(this);
        this.close = this.close.bind(this);
        this.open = this.open.bind(this);

        document.addEventListener('open-nav', this.open);
        document.addEventListener('close-nav', this.close);

        var event = new Event('side-nav-ready');
        document.dispatchEvent(event);
      },

      isOpen: function() {
        return this.rootElement.classList.contains('side-nav--visible');
      },

      toggle: function() {
        if (this.isOpen()) {
          this.close();
        } else {
          this.open();
        }
      },

      close: function() {
        console.log("nav close called");
        this.rootElement.classList.remove('side-nav--visible');
        this.sideNavContent.classList.add('side-nav__content--animatable');

        if (this.hasUnprefixedTransform) {
          console.log('hasUnprefixedTransform route');
          this.sideNavContent.style.transform = 'translateX(-102%)';
          console.log('set transform to -102%');
        } else {
          console.log('non - hasUnprefixedTransform route');
          this.sideNavContent.classList.remove('side-nav--visible');
        }

      },

      open: function() {
        var sideNav = this;
        console.log("nav open called");
        this.rootElement.classList.add('side-nav--visible');

        if (this.hasUnprefixedTransform) {
          var onSideNavTransitionEnd = function(e) {
            sideNav.sideNavBody.focus();

            sideNav.sideNavContent.classList.remove('side-nav__content--animatable');
            sideNav.sideNavContent.removeEventListener('transitionend',
                onSideNavTransitionEnd);
          };

          this.sideNavContent.classList.add('side-nav__content--animatable');
          this.sideNavContent.addEventListener('transitionend',
                onSideNavTransitionEnd);

          requestAnimationFrame( function() {
            sideNav.sideNavContent.style.transform = 'translateX(0px)';
            console.log('set transform to 0px');
          });
        } else {
          this.sideNavContent.classList.add('side-nav--visible');
        }
      },

      togglePin: function(e) {
        this.pin.classList.toggle('pinned');
      }
    });
  </script>
</dom-module>