<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="app-sidenav">
  <!-- Defines the element's style and local DOM -->
  <<!-- link rel="stylesheet" type="text/css" href="app-sidenav.css"> -->
  <template>
    <section class="side-nav js-side-nav">
      <div class="side-nav__content js-side-nav-content" on-scroll="handleSideNavContentScroll" on-touchstart="handleSideNavTouchStart" on-touchmove="handleSideNavTouchMove" on-touchend="handleSideNavTouchEnd">
        <div class="side-nav__header">
          <button class="side-nav__pin" on-click="togglePin"></button>
          <h1 class="side-nav__title">App shell</h1>
        </div>

        <div class="side-nav__body">
          <div class="side-nav__links">
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
            <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
            
          </div>
          <div class="side-nav__version">Version @VERSION@</div>
        </div>
      </div>
    </section>
    <div class="side-nav__edgearea js-side-nav-edgearea" on-touchstart="handleEdgeTouchStart" on-touchmove="handleEdgeTouchMove" on-touchend="handleEdgeTouchEnd"></div>
  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'app-sidenav',

      ready: function(){
        this.sideNavContent = this.querySelector('.js-side-nav-content');
        this.pin = this.querySelector('.side-nav__pin');
        this.edge = document.querySelector('.js-side-nav-edgearea');

        this.sideNavContentWidth = this.sideNavContent.offsetWidth;

        this.addEventListener('click', function(e) {
          this.close();
        });

        this.sideNavContent.addEventListener('click', function(e) {
          e.stopPropagation();
        });

        this.preventSlidingWhileScrolling = false;
        this.touching = false;

        // Touch slop is a variable that is defined to suggest anything larger
        // than this value was an intended gesture by the user.
        // 8  is a value from Android platform.
        // 3 was added as a factor made up from what felt right.
        this.TOUCH_SLOP = 8 * window.devicePixelRatio * 3;;
        this.hasUnprefixedTransform = 'transform' in document.documentElement.style;

        this.toggle = this.toggle.bind(this);
        this.close = this.close.bind(this);
        this.open = this.open.bind(this);

        document.addEventListener('open-nav', this.open);
        document.addEventListener('close-nav', this.close);

        var event = new Event('side-nav-ready');
        document.dispatchEvent(event);
      },

      properties: {
        opened: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
          observer: '_openedChanged'
        },
        position: {
          type: String,
          value: 'left',
          reflectToAttribute: true
        }
      },

     _openedChanged: function(newValue, oldValue){
        if(oldValue === undefined){
          return;
        }
        
        if(newValue === true){
          this.open();
        } else{
          this.close();
        }
      },

      handleSideNavContentScroll: function(e){
        if(this.touching){
            this.preventSlidingWhileScrolling = true;
          }
      },

      handleSideNavTouchStart: function(e) {
        this.touching = true;
        this.sideNavTransform = 0;
        this.touchStartX = e.touches[0].pageX;
      },

      handleSideNavTouchMove: function(e) {
        if(this.preventSlidingWhileScrolling){
          return;
        }

        var newTouchX = e.touches[0].pageX;

        if(Math.abs(newTouchX - this.touchStartX) > (3 * window.devicePixelRatio)){
          this.sideNavContent.style.overflowY = 'hidden';
        } 

        this.sideNavTransform = Math.min(0, newTouchX - this.touchStartX);
        this.sideNavContent.style.transform =
          'translate3d(' + this.sideNavTransform + 'px, 0, 0)';
      },

      handleSideNavTouchEnd: function(e) {
        
        this.touching = false;
        this.preventSlidingWhileScrolling = false;

        if (this.sideNavTransform < -this.TOUCH_SLOP) {
          this.close();
        } else if (this.sideNavTransform < -window.devicePixelRatio/100){
          this.open();
        }

        // allow content scrolling again
        this.sideNavContent.style.overflowY = 'auto';
      },

      handleEdgeTouchStart: function(e) {
        this.sideNavContentWidth = this.sideNavContent.offsetWidth;
        this.edgeTransform = 0;
        this.edgeTouchStartX = e.touches[0].pageX;; 
        this.sideNavContent.style.transform = 'translate3d(-95%, 0 , 0)';
      },

      handleEdgeTouchMove: function(e) {
        var newEdgeTouchX = e.touches[0].pageX;;
        this.edgeTransform = Math.min(this.sideNavContentWidth, newEdgeTouchX - this.edgeTouchStartX);
        this.sideNavContent.style.transform =
          'translate3d(' + (-this.sideNavContentWidth + this.edgeTransform) + 'px, 0, 0)';
      },

      handleEdgeTouchEnd: function(e) {
        if (this.edgeTransform >= this.TOUCH_SLOP) {
          this.open();
          return;
        } else if (this.edgeTransform < this.TOUCH_SLOP){
          this.close();
        }
      },

      toggle: function() {
        this.opened = !this.opened;
      },

      close: function() {
        console.log("nav close called");
        this.opened = false;
        this.sideNavContent.style.transform = 'translate3d(-100%, 0, 0)';
        // this.rootElement.classList.remove('side-nav--visible');
        // this.sideNavContent.classList.add('side-nav__content--animatable');

        if (this.hasUnprefixedTransform) {
          this.sideNavContent.style.transform = 'translate3d(-100%, 0, 0)';
        } else {
           this.sideNavContent.classList.remove('side-nav--visible');
        }
      },

      open: function() {
        this.opened = true;
        
        // var sideNav = this;
        // console.log("nav open called");
        // this.rootElement.classList.add('side-nav--visible');

        if (this.hasUnprefixedTransform) {
        //   var onSideNavTransitionEnd = function(e) {
        //     sideNav.sideNavContent.classList.remove('side-nav__content--animatable');
        //     sideNav.sideNavContent.removeEventListener('transitionend',
        //         onSideNavTransitionEnd);
        //   };

        //   this.sideNavContent.classList.add('side-nav__content--animatable');
        //   this.sideNavContent.addEventListener('transitionend',
        //         onSideNavTransitionEnd);

        //   requestAnimationFrame( function() {
        //     sideNav.sideNavContent.style.transform = 'translateX(0px)';
        //     console.log('set transform to 0px');
        //   });
          this.sideNavContent.style.transform = 'translate3d(0, 0, 0)';
        } else {
          this.sideNavContent.classList.add('side-nav--visible');
        }
      },

      togglePin: function(e) {
        this.pin.classList.toggle('pinned');
      }
    });
  </script>
</dom-module>