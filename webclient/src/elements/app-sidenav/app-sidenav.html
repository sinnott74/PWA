<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<dom-module id="app-sidenav">
  <!-- Defines the element's style and local DOM -->
  <<!-- link rel="stylesheet" type="text/css" href="app-sidenav.css"> -->
  <template>
    <div class="side-nav__content js-side-nav-content" on-touchstart="_handleSideNavTouchStart" on-touchmove="_handleSideNavTouchMove" on-touchend="_handleSideNavTouchEnd">
      <div class="side-nav__header">
        <button class="side-nav__pin" on-click="togglePin"></button>
        <h1 class="side-nav__title">App shell</h1>
      </div>

      <div class="side-nav__body js-side-nav-body">
        <div class="side-nav__links">
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/users">Users</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/">Index</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-1">URL 1</a>
          <a role="tab" tabindex="0" class="side-nav__blog-post" href="/url-2">URL 2</a>
        </div>
        <div class="side-nav__version">Version @VERSION@</div>
      </div>
    </div>
    <div class="side-nav__edgearea js-side-nav-edgearea" on-touchstart="_handleEdgeTouchStart" on-touchmove="_handleEdgeTouchMove" on-touchend="_handleEdgeTouchEnd"></div>
  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'app-sidenav',

      ready: function(){
        this.sideNavContent = this.querySelector('.js-side-nav-content');
        this.pin = this.querySelector('.side-nav__pin');
        this.edge = document.querySelector('.js-side-nav-edgearea');
        this.body = this.querySelector('.js-side-nav-body');
        this.addEventListener('transitionend', this.onTransitionEnd, false);


        this.sideNavContentWidth = this.sideNavContent.offsetWidth;

        this.addEventListener('click', function(e) {
          this.opened = false;
        });

        this.sideNavContent.addEventListener('click', function(e) {
          e.stopPropagation();
        });

        this.addEventListener('scroll', function(e) {
          e.stopPropagation();
        });

        this.body.addEventListener('scroll', function(e) {
          e.stopPropagation();
        });


        this.touching = false;

        // Touch slop is a variable that is defined to suggest anything larger
        // than this value was an intended gesture by the user.
        // 8  is a value from Android platform.
        // 3 was added as a factor made up from what felt right.
        this.TOUCH_SLOP = 8 * window.devicePixelRatio * 3;;

        this._close = this._close.bind(this);
        this._open = this._open.bind(this);
        this._updateUI = this._updateUI.bind(this);

        var event = new Event('side-nav-ready');
        document.dispatchEvent(event);
      },

      properties: {
        opened: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
          observer: '_openedChanged'
        },
        position: {
          type: String,
          value: 'left',
          reflectToAttribute: true
        }
      },

     _openedChanged: function(newValue, oldValue){

        // prevents updating sidenav when value is set upon instantiation
        if(oldValue === undefined){
          return;
        }

        if(newValue === true){
          this._open();
        } else{
          this._close();
        }
      },

      _handleSideNavTouchStart: function(e) {
        this.touching = true;
        this.sideNavTransform = 0;
        this.touchStartX = e.touches[0].pageX;
        this.touchStartY = e.touches[0].pageY;
        this.translateX = 0;
        this.translateY = 0;
        this.direction = "";
      },

      _handleSideNavTouchMove: function(e) {
        var newTouchX = e.touches[0].pageX;
        var newTouchY = e.touches[0].pageY;

        this.translateX = newTouchX - this.touchStartX;
        this.translateY = newTouchY - this.touchStartY;

        if(!this.direction){

          if(Math.abs(this.translateX) >= Math.abs(this.translateY)){
            this.direction = "horizontal";
          } else {
            this.direction = "vertical";
          }
        }

        if(this.direction == "horizontal"){

          e.preventDefault();
          requestAnimationFrame(this._updateUI);
        }
      },

      _updateUI: function() {
         if(this.touching){

            // if(Math.abs(this.translateX) > (3 * window.devicePixelRatio)){
            //   this.sideNavContent.style.overflowY = 'hidden';
            // }

            this.sideNavTransform = Math.min(0, this.translateX);
            this.sideNavContent.style.transform =
              'translate3d(' + this.sideNavTransform + 'px, 0, 0)';

            requestAnimationFrame(this._updateUI);
          }
      },

      _handleSideNavTouchEnd: function(e) {

        this.touching = false;
        this.direction = "";

        if (this.sideNavTransform < -this.TOUCH_SLOP) {
          this._close();
        } else if (this.sideNavTransform < -window.devicePixelRatio/100){
          this._open();
        }

        // allow content scrolling again
        // this.sideNavContent.style.overflowY = 'auto';
      },

      _handleEdgeTouchStart: function(e) {
        this.sideNavContentWidth = this.sideNavContent.offsetWidth;
        this.edgeTransform = 0;
        this.direction = "";
        this.edgeTouchStartX = e.touches[0].pageX;
        this.edgeTouchStartY = e.touches[0].pageY;
        this.sideNavContent.style.transform = 'translate3d(-95%, 0 , 0)';
      },

      _handleEdgeTouchMove: function(e) {
        var newEdgeTouchX = e.touches[0].pageX;
        var newEdgeTouchY = e.touches[0].pageY;

        var translateX = newEdgeTouchX - this.edgeTouchStartX;
        var translateY = newEdgeTouchY - this.edgeTouchStartY;

        if(!this.direction){

          if(Math.abs(translateX) >= Math.abs(translateY)){
            this.direction = "horizontal";
          } else {
            this.direction = "vertical";
          }
        }

        if(this.direction === "horizontal"){

          e.preventDefault();

          this.edgeTransform = Math.min(this.sideNavContentWidth, newEdgeTouchX - this.edgeTouchStartX);
          this.sideNavContent.style.transform =
            'translate3d(' + (-this.sideNavContentWidth + this.edgeTransform) + 'px, 0, 0)';
        }
      },

      _handleEdgeTouchEnd: function(e) {
        this.direction = "";
        if (this.edgeTransform >= this.TOUCH_SLOP) {
          this._open();
          return;
        } else if (this.edgeTransform < this.TOUCH_SLOP){
          this._close();
        }
      },

      _close: function() {
        this.opened = false;
        this.classList.add("side_nav--animatable");
        this.sideNavContent.removeAttribute('style');
        document.body.style.overflowY = 'auto';
      },

      _open: function() {
        this.opened = true;
        this.classList.add("side_nav--animatable");
        this.sideNavContent.removeAttribute('style');
        document.body.style.overflowY = 'hidden';
      },

      togglePin: function(e) {
        this.pin.classList.toggle('pinned');
      },

      onTransitionEnd : function() {
	      this.classList.remove("side_nav--animatable");
      }
    });
  </script>
</dom-module>