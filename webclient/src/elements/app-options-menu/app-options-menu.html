<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="app-options-menu">

  <template>
    <div class="expando js-expando" tabindex="0" focusable>
      <div class="expando__inner js-expando-inner">
        <div class="expando__inner-inverter js-expando-inner-inverter">
          <div class="expando__content js-content">
            <ul class="expando__content-list">
              <li>One</li>
              <li>Two</li>
              <li>Three</li>
              <li>Four</li>
            </ul>

            <!--<button class="expando__close js-expando-collapse-btn">Close</button>-->
          </div>

          <paper-icon-button class="expando__btn js-expando-expand-btn">
          </paper-icon-button>
        </div>
      </div>
    </div>
  </template>

  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'app-options-menu',

      ready: function() {
        this._el = this.querySelector('.js-expando');
        this._elInner = this._el.querySelector('.js-expando-inner');
        this._elInnerInverter = this._el.querySelector('.js-expando-inner-inverter');
        this._expandBtn = this._el.querySelector('.js-expando-expand-btn');
        this._collapseBtn = this._el.querySelector('.js-expando-collapse-btn');
        this._content = this._el.querySelector('.js-content');

        this.toggle = this.toggle.bind(this);
        this.expand = this.expand.bind(this);
        this.collapse = this.collapse.bind(this);

        this._expandBtn.addEventListener('click', this.expand);
        // this._collapseBtn.addEventListener('click', this.collapse);
        this._el.addEventListener('blur', this.collapse);
      },

      attached: function() {
        this._calculate();
        this._createEaseAnimations();
      },

      expand: function() {
        if (this._isExpanded) {
          return;
        }
        this._isExpanded = true;
        this._expand();
        this._el.focus();
      },

      collapse: function() {
        if (!this._isExpanded) {
          return;
        }
        this._isExpanded = false;
        this._collapse();
      },

      toggle: function() {
        if (this._isExpanded) {
          return this.collapse();
        }

        this.expand();
      },

      _removeClasses: function() {
        this._elInner.classList.remove('item--expanded');
        this._elInner.classList.remove('item--collapsed');
        this._elInnerInverter.classList.remove('item__contents--expanded');
        this._elInnerInverter.classList.remove('item__contents--collapsed');

        // Force a recalc styles here so the classes take hold.
        window.getComputedStyle(this._elInner).transform;

      },

      _expand: function() {
        this._removeClasses();
        this._elInner.classList.add('item--expanded');
        this._elInnerInverter.classList.add('item__contents--expanded');
      },

      _collapse: function() {
        this._removeClasses();
        this._elInner.classList.add('item--collapsed');
        this._elInnerInverter.classList.add('item__contents--collapsed');
      },

      _calculate: function() {
        var elBCR = this._el.getBoundingClientRect();
        var collapsed = this._expandBtn.getBoundingClientRect();
        var expanded = this._content.getBoundingClientRect();

        var expandedWidth = Math.abs(expanded.left - elBCR.right);
        var expandedHeight = Math.abs(expanded.bottom - elBCR.top);

        var collapsedWidth = collapsed.width;
        var collapsedHeight = collapsed.height;

        var exRadius = Math.sqrt(expandedWidth * expandedWidth +
            expandedHeight * expandedHeight);
        var colRadius = collapsedWidth * 0.5;

        this._scale = (exRadius - colRadius) / colRadius;

        // Set initial sizes.
        this._el.style.width = expandedWidth + 'px';
        this._el.style.height = expandedHeight+ 'px';

        this._elInner.style.width = collapsedWidth +'px';
        this._elInner.style.height = collapsedHeight + 'px';

        this._elInner.style.transformOrigin =
            (collapsedWidth * 0.5) + 'px ' + (collapsedHeight * 0.5) + 'px';
        this._elInnerInverter.style.transformOrigin =
            (collapsedWidth * 0.5) + 'px ' + (collapsedHeight * 0.5) + 'px';

      },

      _createEaseAnimations: function() {
        var ease = document.querySelector('.ease');
        if (ease) {
          return ease;
        }

        ease = document.createElement('style');
        ease.classList.add('ease');

        var expandAnimation = [];
        var expandContentsAnimation = [];
        var expandCircleAnimation = [];
        var collapseAnimation = [];
        var collapseContentsAnimation = [];
        var collapseCircleAnimation = [];
        for (var i = 0; i <= 100; i++) {
          var step = this._ease(i/100);

          // Expand animation.
          this._append({
            i: i,
            step: step,
            start: 1,
            end: this._scale,
            outerAnimation: expandAnimation,
            innerAnimation: expandContentsAnimation
          });

          // Collapse animation.
          this._append({
            i: i,
            step: step,
            start: this._scale,
            end: 1,
            outerAnimation: collapseAnimation,
            innerAnimation: collapseContentsAnimation
          });
        }

        // ease.textContent = `
        //   @keyframes expandAnimation {
        //     ${expandAnimation.join('')}
        //   }
        //   @keyframes expandContentsAnimation {
        //     ${expandContentsAnimation.join('')}
        //   }
        //   @keyframes collapseAnimation {
        //     ${collapseAnimation.join('')}
        //   }
        //   @keyframes collapseContentsAnimation {
        //     ${collapseContentsAnimation.join('')}
        //   }`;

        ease.textContent = '@keyframes expandAnimation { ' + expandAnimation.join('') + '} @keyframes expandContentsAnimation { ' + expandContentsAnimation.join('') + '} @keyframes collapseAnimation { ' + collapseAnimation.join('') + '}  @keyframes collapseContentsAnimation { ' + collapseContentsAnimation.join('') + '}';

        document.head.appendChild(ease);
        return ease;
      },

      _append: function(opts) {
        var i = opts.i;
        var step = opts.step;
        var start = opts.start;
        var end = opts.end;
        var outerAnimation = opts.outerAnimation;
        var innerAnimation = opts.innerAnimation;

        var scale = start + (end - start) * step;
        var invScale = 1 / scale;

        // outerAnimation.push(`
        //   ${i}% {
        //     transform: scale(${scale});
        //   }`);
        outerAnimation.push(i + '% {transform: scale(' + scale + ');}');

        // innerAnimation.push(`
        //   ${i}% {
        //     transform: scale(${invScale});
        //   }`);
        innerAnimation.push(i + '% {transform: scale(' + invScale + ');}');
      },

      _clamp: function(value, min, max) {
        return Math.max(min, Math.min(max, value));
      },

      _ease: function(v, pow) {
        pow = pow || 4;

        v = this._clamp(v, 0, 1);

        return 1 - Math.pow(1 - v, pow);
      }
    });
  </script>
</dom-module>